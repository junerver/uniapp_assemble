<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼ºåˆ¶åˆ·æ–°é¡µé¢ - è§£å†³SSEè¿æ¥é—®é¢˜</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .step { background: #e8f5e8; border-left: 4px solid #4caf50; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        button:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 14px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¼ºåˆ¶åˆ·æ–°é¡µé¢ - è§£å†³SSEè¿æ¥é—®é¢˜</h1>

        <div class="warning">
            <h3>âš ï¸ é—®é¢˜è¯´æ˜</h3>
            <p>æ£€æµ‹åˆ°æ‚¨çš„æµè§ˆå™¨æ­£åœ¨ä¸æ–­é‡æ–°è¿æ¥SSEæ—¥å¿—æµç«¯ç‚¹ï¼Œè¿™é€šå¸¸æ˜¯ç”±äºæµè§ˆå™¨ç¼“å­˜äº†æ—§ç‰ˆæœ¬çš„JavaScriptä»£ç å¯¼è‡´çš„ã€‚</p>
            <p><strong>ç—‡çŠ¶ï¼š</strong> æµè§ˆå™¨ç½‘ç»œé¢æ¿æ˜¾ç¤ºæ¯3ç§’å‘ /api/builds/tasks/.../logs/stream å‘é€æ–°è¯·æ±‚</p>
        </div>

        <div class="step">
            <h3>ğŸ“‹ è§£å†³æ­¥éª¤</h3>
            <ol>
                <li><strong>ç¬¬ä¸€æ­¥ï¼š</strong>ç‚¹å‡»ä¸‹é¢çš„"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"æŒ‰é’®</li>
                <li><strong>ç¬¬äºŒæ­¥ï¼š</strong>å¦‚æœç¬¬ä¸€æ­¥æ— æ•ˆï¼Œæ‰‹åŠ¨æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°</li>
                <li><strong>ç¬¬ä¸‰æ­¥ï¼š</strong>å¦‚æœä»ç„¶æ— æ•ˆï¼Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜</li>
                <li><strong>ç¬¬å››æ­¥ï¼š</strong>ä½¿ç”¨æ— ç—•/éšç§æ¨¡å¼é‡æ–°è®¿é—®</li>
            </ol>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="clearCacheAndRefresh()" class="btn-danger">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>
            <button onclick="forceRefresh()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢</button>
            <button onclick="testSSEConnection()" class="btn-success">ğŸ§ª æµ‹è¯•SSEè¿æ¥</button>
        </div>

        <div id="test-results" class="hidden">
            <h3>ğŸ§ª SSEè¿æ¥æµ‹è¯•ç»“æœ</h3>
            <div id="test-log" class="log">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
        </div>

        <div class="success">
            <h3>âœ… éªŒè¯æˆåŠŸæ ‡å¿—</h3>
            <p>å½“æ‚¨çœ‹åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œè¯´æ˜é—®é¢˜å·²è§£å†³ï¼š</p>
            <ul>
                <li>SSEè¿æ¥ä¸å†æ¯3ç§’é‡æ–°å»ºç«‹</li>
                <li>æ„å»ºæ—¥å¿—æ˜¾ç¤º"ä»»åŠ¡å·²å®Œæˆï¼"è€Œä¸æ˜¯ä¸æ–­"å·²è¿æ¥åˆ°å®æ—¶æ—¥å¿—æµ"</li>
                <li>æµè§ˆå™¨ç½‘ç»œé¢æ¿ä¸å†æ˜¾ç¤ºæŒç»­çš„streamè¯·æ±‚</li>
            </ul>
        </div>

        <div class="error">
            <h3>âŒ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨</h3>
            <p>è¯·è”ç³»å¼€å‘è€…æˆ–æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯ã€‚</p>
            <p><strong>ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š</strong> ä½¿ç”¨æµ‹è¯•é¡µé¢ <a href="/test_sse.html" target="_blank">test_sse.html</a> éªŒè¯åç«¯æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        </div>
    </div>

    <script>
        function addLog(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearCacheAndRefresh() {
            addLog('å¼€å§‹æ¸…é™¤ç¼“å­˜...');

            // æ¸…é™¤localStorage
            try {
                localStorage.clear();
                addLog('âœ… å·²æ¸…é™¤localStorage');
            } catch (e) {
                addLog(`âŒ æ¸…é™¤localStorageå¤±è´¥: ${e.message}`);
            }

            // æ¸…é™¤sessionStorage
            try {
                sessionStorage.clear();
                addLog('âœ… å·²æ¸…é™¤sessionStorage');
            } catch (e) {
                addLog(`âŒ æ¸…é™¤sessionStorageå¤±è´¥: ${e.message}`);
            }

            // å¼ºåˆ¶åˆ·æ–°é¡µé¢
            setTimeout(() => {
                addLog('ğŸ”„ æ­£åœ¨åˆ·æ–°é¡µé¢...');
                window.location.href = window.location.href + '?t=' + Date.now();
            }, 1000);
        }

        function forceRefresh() {
            addLog('ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢...');
            window.location.href = window.location.href + '?t=' + Date.now();
        }

        function testSSEConnection() {
            const resultsDiv = document.getElementById('test-results');
            const logDiv = document.getElementById('test-log');

            resultsDiv.classList.remove('hidden');
            logDiv.innerHTML = 'å¼€å§‹SSEè¿æ¥æµ‹è¯•...\n';

            addLog('ğŸ”— è¿æ¥åˆ°SSEç«¯ç‚¹...');

            const eventSource = new EventSource('/api/builds/tasks/a58a2d40-250c-463b-9082-85e0c38ff3e0/logs/stream');
            let eventCount = 0;
            let completedReceived = false;

            const timeout = setTimeout(() => {
                if (!completedReceived) {
                    addLog('â° æµ‹è¯•è¶…æ—¶ï¼ˆ10ç§’ï¼‰');
                    addLog('ğŸ“Š æ”¶åˆ°çš„äº‹ä»¶æ•°é‡: ' + eventCount);
                    eventSource.close();

                    if (eventCount >= 3 && completedReceived) {
                        addLog('âœ… SSEè¿æ¥æ­£å¸¸å·¥ä½œï¼');
                    } else {
                        addLog('âŒ SSEè¿æ¥å¯èƒ½å­˜åœ¨é—®é¢˜');
                    }
                }
            }, 10000);

            eventSource.addEventListener('open', () => {
                addLog('ğŸ”— SSEè¿æ¥å·²å»ºç«‹');
                eventCount++;
            });

            eventSource.addEventListener('connected', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addLog(`âœ… æ”¶åˆ°è¿æ¥äº‹ä»¶: ${data.message}`);
                    eventCount++;
                } catch (error) {
                    addLog(`âœ… æ”¶åˆ°è¿æ¥äº‹ä»¶: ${event.data}`);
                    eventCount++;
                }
            });

            eventSource.addEventListener('status', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addLog(`ğŸ“Š æ”¶åˆ°çŠ¶æ€äº‹ä»¶: ${data.status} (${data.progress}%)`);
                    eventCount++;
                } catch (error) {
                    addLog(`ğŸ“Š æ”¶åˆ°çŠ¶æ€äº‹ä»¶: ${event.data}`);
                    eventCount++;
                }
            });

            eventSource.addEventListener('completed', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addLog(`ğŸ¯ æ”¶åˆ°å®Œæˆäº‹ä»¶: final=${data.final}, status=${data.status}`);
                    eventCount++;
                    completedReceived = true;

                    if (data.final) {
                        addLog('âœ… æ”¶åˆ°æœ€ç»ˆå®Œæˆäº‹ä»¶ï¼ŒSSEå·¥ä½œæ­£å¸¸ï¼');
                        clearTimeout(timeout);
                        setTimeout(() => {
                            eventSource.close();
                            addLog('ğŸ”š æµ‹è¯•å®Œæˆï¼Œå…³é—­SSEè¿æ¥');
                        }, 1000);
                    }
                } catch (error) {
                    addLog(`ğŸ¯ æ”¶åˆ°å®Œæˆäº‹ä»¶: ${event.data}`);
                    eventCount++;
                    completedReceived = true;
                }
            });

            eventSource.addEventListener('error', (event) => {
                addLog(`âŒ SSEé”™è¯¯: ${event.type}`);
                eventCount++;
            });

            eventSource.addEventListener('timeout', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addLog(`â° æ”¶åˆ°è¶…æ—¶äº‹ä»¶: ${data.message}`);
                    eventCount++;
                } catch (error) {
                    addLog(`â° æ”¶åˆ°è¶…æ—¶äº‹ä»¶: ${event.data}`);
                    eventCount++;
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
        window.addEventListener('load', () => {
            console.log('å¼ºåˆ¶åˆ·æ–°é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>